---
import fs from "node:fs";
import path from "node:path";
import BaseHead from "$components/BaseHead.astro";
import BlogPost from "$layouts/BlogPost.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: {
      file: path.join("html", post.id, "index.html"),
      slug: post.id,
    },
  }));
}

const { file, slug } = Astro.props as { file: string; slug: string };
const html = fs.readFileSync(file, "utf8");
const posts = (await getCollection("blog"))
  .map((p) => {
    const sortDate = p.data.updatedDate ?? p.data.date;
    const sortMs =
      sortDate instanceof Date
        ? sortDate.valueOf()
        : new Date(sortDate as unknown as string).valueOf();
    return { ...p, sortMs };
  })
  .sort((a, b) => b.sortMs - a.sortMs);
const post = posts.find((p) => p.id === slug)!;
const allTags = Array.from(
  new Set(posts.flatMap((p) => p.data.tags ?? []))
).sort();
---

<BlogPost
  title={post.data.title}
  desc={post.data.desc}
  date={post.data.date}
  updatedDate={post.data.updatedDate}
  tags={post.data.tags}
>
  <BaseHead title={post.data.title} description={post.data.desc} />
  <div set:html={html} />
</BlogPost>
